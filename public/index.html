<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TradeXinvest</title>
  <link rel="stylesheet" href="style.css" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  />
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    .testimonials-section {
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 1rem;
      font-family: Arial, sans-serif;
    }
    .testimonials-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      justify-content: center;
    }
    .testimonial-box {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 1.5rem;
      flex: 1 1 280px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    .testimonial-box p {
      font-size: 1.1rem;
      color: #555;
      margin: 1rem 0 0.8rem;
    }
    .testimonial-box h4 {
      color: #555;
      font-weight: 600;
      margin: 0;
    }
    .stars {
      font-size: 1.3rem;
      color: #f5a623; /* gold star color */
      user-select: none;
    }
    .stars span {
      letter-spacing: 2px;
    }
    .profile-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .profile-info img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ddd;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .profile-info h3 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
    }
    /* Hide withdraw form by default */
    .withdraw-form.hidden {
      display: none;
    }
    /* Chat widget styles */
    .chat-widget {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      max-height: 400px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      font-family: Arial, sans-serif;
      display: none; /* hidden by default */
      z-index: 10000;
    }
    .chat-header {
      background: #007bff;
      color: white;
      padding: 10px;
      font-weight: bold;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
    }
    .chat-body {
      flex-grow: 1;
      padding: 10px;
      overflow-y: auto;
      background: #f9f9f9;
    }
    .message {
      margin-bottom: 8px;
      padding: 6px 10px;
      border-radius: 12px;
      max-width: 80%;
      word-wrap: break-word;
    }
    .message.user {
      background: #d1e7dd;
      align-self: flex-end;
    }
    .message.admin {
      background: #f8d7da;
      align-self: flex-start;
    }
    .message.system {
      background: #e2e3e5;
      font-style: italic;
      color: #555;
      align-self: center;
      max-width: 90%;
    }
    #chatForm {
      display: flex;
      border-top: 1px solid #ddd;
    }
    #chatInput {
      flex-grow: 1;
      border: none;
      padding: 10px;
      font-size: 1rem;
      border-radius: 0 0 0 8px;
      outline: none;
    }
    #chatForm button {
      border: none;
      background: #007bff;
      color: white;
      padding: 0 20px;
      cursor: pointer;
      border-radius: 0 0 8px 0;
    }
    :root{
    --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --brand:#22c55e; --danger:#ef4444;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .container{max-width:1100px;margin:0 auto;padding:24px}
  .grid{display:grid;gap:16px}
  .two{grid-template-columns:1fr 1fr}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  h1,h2,h3{margin:.4em 0}
  input,select,button,textarea{
    width:100%;padding:12px 14px;border-radius:12px;border:1px solid #253041;background:#0b1220;color:var(--text);
    outline:none
  }
  input::placeholder{color:#6b7280}
  button{cursor:pointer;transition:transform .05s ease, opacity .15s ease}
  button:hover{opacity:.95}
  .btn{background:#1f2937}
  .btn-primary{background:var(--brand);color:#052e16;border:none}
  .btn-danger{background:var(--danger);border:none}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .row>.grow{flex:1}
  .muted{color:var(--muted);font-size:.9rem}
  .hidden{display:none !important}

  /* Overlay + Modal */
  #overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter: blur(2px);z-index:1000}
  .modal{display:none;position:fixed;inset:auto;top:50%;left:50%;transform:translate(-50%,-50%);
    background:#0b1220;border:1px solid #26334d;border-radius:16px;padding:20px;z-index:1001;min-width:min(92vw,520px)}
  .modal h3{margin-top:0}
  .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}

  /* Tables */
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #1f2937;text-align:left}
  th{color:#9ca3af;font-weight:600}

  /* Header */
  .topbar{position:sticky;top:0;background:rgba(15,23,42,.7);backdrop-filter:blur(6px);border-bottom:1px solid #1f2937;z-index:50}
  .topbar-inner{display:flex;align-items:center;justify-content:space-between;padding:12px 24px}
  .brand{font-weight:700;letter-spacing:.3px}
  .pill{padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid #1f2937}

  /* Stat cards */
  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .stat{background:#0b1220;border:1px solid #1f2937;border-radius:14px;padding:16px}
  .stat .label{color:#94a3b8;font-size:.9rem}
  .stat .value{font-size:1.4rem;font-weight:700;margin-top:6px}

  /* Sliders */
  #welcomeNote img{display:none;width:100%;max-height:180px;object-fit:cover;border-radius:12px;border:1px solid #1f2937}
  #welcomeNote img.active{display:block}
  #quotes p{display:none;font-style:italic;margin:0}
  #quotes p.active{display:block}

  /* Admin tabs */
  .tabs{display:flex;gap:8px;margin-bottom:10px}
  .tabs button{padding:8px 12px;border-radius:10px}
  .tabs button.active{background:#19324f}

  /* Tiny helper */
  .right{float:right}
  </style>
</head>
<body>
  <div class="lowerNAV" onclick="toggleMobileNav()">
    <div style="display: flex; flex-direction: column; gap: 4px;">
      <span style="width: 30px; height: 4px; background-color: black;"></span>
      <span style="width: 30px; height: 4px; background-color: black;"></span>
      <span style="width: 30px; height: 4px; background-color: black;"></span>
    </div>
  </div>

  <ul class="mobile-menu" id="mobileMenu">
    <li><a href="index.html">Home</a></li>
    <li><a href="about.html">About Us</a></li>
    <li><a href="contact.html">Contact</a></li>
  </ul> 
   <div class="nav">
    <p class="logo">TradeXInvest</p>
    </div>
    

<!-- end of dashboard -->
 <!-- Topbar -->
<div class="topbar">
  <div class="topbar-inner container">
    <div class="brand">TradexInvest</div>
    <div class="row">
      <button id="openLogin" class="pill">Login</button>
      <button id="openSignup" class="pill">Sign Up</button>
      <button id="openDashboard" class="pill hidden">Dashboard</button>
      <button id="openAdmin" class="pill hidden">Admin</button>
      <button id="logoutTop" class="pill hidden">Logout</button>
    </div>
  </div>
</div>
  <div class="card">
      <h3>Welcome</h3>
      <div id="welcomeNote">
        <img src="https://picsum.photos/seed/a/1100/280" class="active" alt="">
        <img src="https://picsum.photos/seed/b/1100/280" alt="">
        <img src="https://picsum.photos/seed/c/1100/280" alt="">
      </div>
      <div style="margin-top:12px" id="quotes">
        <p class="active">‚ÄúInvest smart, live better.‚Äù</p>
        <p>‚ÄúYour future starts today.‚Äù</p>
        <p>‚ÄúProfit is a journey, not a destination.‚Äù</p>
      </div>
    </div>

<div class="container grid two">

  <!-- Public / left column -->
  <div class="grid">
    <div class="card">
      <h2>Get started</h2>
      <p class="muted">Create an account, log in, accept the terms, verify 2FA, then manage your investments ‚Äî all on this page.</p>
      <div class="row">
        <button id="ctaSignup" class="btn btn-primary">Create account</button>
        <button id="ctaLogin" class="btn">I already have an account</button>
      </div>
    </div>
</div>
    

  <!-- Dashboard / right column -->
  <div class="grid">
    <div id="dashboardCard" class="card hidden">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <h2 id="welcomeUser">Welcome</h2>
          <p id="welcomeEmail" class="muted"></p>
        </div>
        <div>
          <button id="depositBtn" class="btn btn-primary">Deposit</button>
          <button id="withdrawBtn" class="btn right">Withdraw</button>
        </div>
      </div>

      <div class="stats" style="margin-top:10px">
        <div class="stat">
          <div class="label">Investment Balance</div>
          <div class="value">$<span id="statBalance">0</span></div>
        </div>
        <div class="stat">
          <div class="label">Total Profit</div>
          <div class="value">$<span id="statProfit">0</span></div>
        </div>
        <div class="stat">
          <div class="label">Total Interest</div>
          <div class="value">$<span id="statInterest">0</span></div>
        </div>
      </div>

      <div style="margin-top:16px">
        <h3>Recent Transactions</h3>
        <table id="txTable">
          <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Admin panel -->
    <div id="adminCard" class="card hidden">
      <h2>Admin</h2>
      <div class="tabs">
        <button data-tab="usersTab" class="btn active">Users</button>
        <button data-tab="withdrawalsTab" class="btn">Withdrawals</button>
      </div>

      <div id="usersTab">
        <table>
          <thead><tr><th>Name</th><th>Email</th><th>Balance</th><th>Profit</th><th style="width:200px">Actions</th></tr></thead>
          <tbody id="adminUsersBody"></tbody>
        </table>
      </div>

      <div id="withdrawalsTab" class="hidden">
        <table>
          <thead><tr><th>User</th><th>Method</th><th>Amount</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="adminWdBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ===== Overlay + Modals ===== -->
<div id="overlay"></div>

<!-- Signup Modal -->
<div id="signupModal" class="modal">
  <h3>Create account</h3>
  <div class="row">
    <input id="suName" placeholder="Full name" class="grow" />
    <input id="suEmail" placeholder="Email" class="grow" />
  </div>
  <div class="row" style="margin-top:10px">
    <input id="suPassword" placeholder="Password" type="password" class="grow" />
  </div>
  <div class="actions">
    <button class="btn" data-close="signupModal">Cancel</button>
    <button id="signupSubmit" class="btn btn-primary">Sign Up</button>
  </div>
</div>

<!-- Login Modal -->
<div id="loginModal" class="modal">
  <h3>Login</h3>
  <input id="liEmail" placeholder="Email" />
  <div style="height:8px"></div>
  <input id="liPassword" placeholder="Password" type="password" />
  <div class="actions">
    <button class="btn" data-close="loginModal">Cancel</button>
    <button id="loginSubmit" class="btn btn-primary">Login</button>
  </div>
</div>

<!-- Terms Modal -->
<div id="termsModal" class="modal">
  <h3>Terms & Conditions</h3>
  <div style="max-height:220px;overflow:auto;border:1px solid #1f2937;border-radius:10px;padding:12px">
    <p class="muted">By continuing, you agree to our terms regarding investments, risk disclosure, and platform policies.</p>
    <ul class="muted">
      <li>Investments involve risk of loss.</li>
      <li>Profits shown are indicative and not guaranteed.</li>
      <li>We may require identity verification for withdrawals.</li>
    </ul>
  </div>
  <div class="actions">
    <button class="btn" data-close="termsModal">Decline</button>
    <button id="acceptTerms" class="btn btn-primary">I Accept</button>
  </div>
</div>

<!-- 2FA Modal -->
<div id="twofaModal" class="modal">
  <h3>Two-Factor Verification</h3>
  <p class="muted" id="twofaHint">We‚Äôve emailed a 6-digit code to your address.</p>
  <input id="twofaCode" placeholder="Enter 2FA code" />
  <div class="row" style="align-items:center;margin-top:8px">
    <div id="countdown" class="muted">Code expires in 5:00</div>
    <button id="resend2FA" class="btn right">Resend code</button>
  </div>
  <div class="actions">
    <button class="btn" data-close="twofaModal">Cancel</button>
    <button id="verify2FA" class="btn btn-primary">Verify</button>
  </div>
</div>

<!-- Deposit Modal -->
<div id="depositModal" class="modal">
  <h3>Deposit</h3>
  <input id="depositAmount" placeholder="Amount (USD)" />
  <div class="actions">
    <button class="btn" data-close="depositModal">Close</button>
    <button id="submitDeposit" class="btn btn-primary">Deposit</button>
  </div>
</div>

<!-- Withdraw Modal -->
<div id="withdrawModal" class="modal">
  <h3>Withdraw</h3>
  <input id="withdrawAmount" placeholder="Amount (USD)" />
  <div style="height:8px"></div>
  <select id="withdrawMethod">
    <option value="bank">Bank-to-Bank</option>
    <option value="paypal">PayPal</option>
    <option value="bitcoin">Bitcoin</option>
    <option value="cashapp">CashApp</option>
  </select>
  <div class="actions">
    <button class="btn" data-close="withdrawModal">Close</button>
    <button id="submitWithdraw" class="btn btn-primary">Request Withdraw</button>
  </div>
</div>


    
<!-- end  -->
    <div id="welcomeNote" class="welcomeNote">
      <img src="images/photo 5.avif" alt="img" />
      <img src="images/stock 1.webp" alt="img" />
      <img src="images/photo 7.avif" alt="img" />
      <img src="images/photo-1749741326969-e1676b3bce43.avif" alt="img" />
    </div>
    <div id="qoutes" class="qoutes">
      <p> WE ARE TRADEX</p>
      <p>"Do not save what is left after spending, but spend what is left after saving."</p>
      <p>"An investment in knowledge pays the best interest."</p>
      <p>"Successful investing is about managing risk, not avoiding it."</p>
    </div>
    <section id="features" class="features-section">
      <h2>Our Features</h2>
      <div class="features-container">
        <div class="feature-box">
          <i class="fa fa-shield-alt"></i>
          <h3>Secure Platform</h3>
          <p>
            We use top-level security to keep your data and transactions safe at
            all times.
          </p>
        </div>
        <div class="feature-box">
          <i class="fa fa-chart-line"></i>
          <h3>Live Investment Tracking</h3>
          <p>
            View real-time updates of your investment, profit, and total interest
            on your dashboard.
          </p>
        </div>
        <div class="feature-box">
          <i class="fa fa-hand-holding-usd"></i>
          <h3>Flexible Investment Plans</h3>
          <p>
            Choose from a variety of plans that suit your goals and budget with
            high returns.
          </p>
        </div>
        <div class="feature-box">
          <i class="fa fa-headset"></i>
          <h3>24/7 Support</h3>
          <p>
            Our dedicated support team is always here to help you through live
            chat or email.
          </p>
        </div>
      </div>
    </section>
    <div class="live-counter">
      <h3>Total Interest Growing:</h3>
      <p>$<span id="interestCounter">0.00</span></p>
    </div>
    <div class="countdown-box">
      <h3>Next Payout In:</h3>
      <p id="payoutCountdown">Loading...</p>
    </div>
    <section id="whyChooseUs" class="why-section">
      <h2>Why Choose TradeXInvest</h2>
      <div class="why-container">
        <div class="why-box">
          <i class="fa fa-users"></i>
          <h3>Trusted by Thousands</h3>
          <p>
            Over 10,000 investors trust us with their money, and our reviews speak
            for themselves.
          </p>
        </div>
        <div class="why-box">
          <i class="fa fa-bolt"></i>
          <h3>Fast & Easy</h3>
          <p>
            Sign up and start investing in just minutes. User-friendly and
            accessible from any device.
          </p>
        </div>
        <div class="why-box">
          <i class="fa fa-award"></i>
          <h3>Proven Results</h3>
          <p>
            We‚Äôve consistently delivered strong returns for our investors with
            transparent performance.
          </p>
        </div>
      </div>
    </section>
    <section class="hero-section">
      <div class="hero-content">
        <h1>Invest Smart with TradeXInvest</h1>
        <p>
          Your trusted platform to grow wealth with secure and high-yield
          investment plans.
        </p>
        <div class="hero-buttons">
           <button id="ctaSignup" class="btn btn-primary">Create account</button>
          <a href="#features" class="btn-secondary">Learn More</a>
        </div>
      </div>
      <div class="hero-image">
        <img src="images/photo 5.webp" alt="Investment Image" />
      </div>
    </section>

    <section id="testimonials" class="testimonials-section">
      <h2>What Our Investors Say......</h2>
      <div class="testimonials-container">
        <div class="testimonial-box">
          <div class="stars" aria-label="Rating: 5 out of 5 stars">
            <span>‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</span>
          </div>
          <p>
            "TradeXInvest helped me grow my savings steadily. The dashboard is
            simple, and the support team is amazing!"
          </p>
          <h4>‚Äî Sarah U., Australia</h4>
        </div>
        <div class="testimonial-box">
          <div class="stars" aria-label="Rating: 4.5 out of 5 stars">
            <span>‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</span>
          </div>
          <p>
            "I was skeptical at first, but now I‚Äôm earning consistent interest on
            my investment. I recommend it 100%!"
          </p>
          <h4>‚Äî James Eudardo., Brazil</h4>
        </div>
        <div class="testimonial-box">
          <div class="stars" aria-label="Rating: 4 out of 5 stars">
            <span>‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</span>
          </div>
          <p>
            "What I love is the transparency. I see my profits in real time and
            the withdrawals are smooth."
          </p>
          <h4>‚Äî Anita O., New Jersey</h4>
        </div>
      </div>
    </section>

    <section class="cta-section">
      <h2>Ready to Grow Your Wealth?</h2>
      <p>Join thousands of investors earning passive income with TradeXInvest.</p>
      <p> <button id="ctaSignup" class="btn btn-primary">Get Started Now</button></p>
    </section>

    <!-- Chat widget -->
    <div id="chatWidget" class="chat-widget">
      <div
        class="chat-header"
        onclick="document.getElementById('chatWidget').style.display='none';"
      >
        üí¨ Chat With Us (Click header to close)
      </div>
      <div class="chat-body" id="chatBody">
        <div class="message admin">
          Hi TradeX üëã, want help choosing the best plan?
        </div>
      </div>
      <form id="chatForm">
        <input
          type="text" 
          id="chatInput"
          placeholder="Type your message..."
          autocomplete="off"
        />
        <button type="submit">Send</button>
      </form>
    </div>

    <footer class="site-footer">
      <div class="footer-content">
        <h2>TradeXInvest</h2>
        <p>Secure and smart investment platform to grow your wealth.</p>

        <!-- üîó Contact Info -->
        <div class="contact-info">
          <p>
            <i class="fas fa-envelope"></i>
            <a href="mailto:support@tradexinvest.com">support@tradexinvest.com</a>
          </p>
          <p>
            <i class="fas fa-phone"></i>
            <a href="https://wa.me/+13137768220">+13137768220</a>
          </p>
          <p>
            <i class="fas fa-paper-plane"></i>
            <a href="contact.html">Send Us a Message</a>
          </p>
        </div>

        <!-- üîó Social Media -->
        <div class="social-icons">
          <a
            href="https://signal.me/#eu/B0bK1TWO1rDFGcCqWeraUIdHqG29QV04qxhVbyN4zxW5N3TXSEtPwY6Dcy9JaDGm"
            target="_blank"
            class="icon facebook"
            ><i class="fab fa-facebook-f"></i
          ></a>
          <a
            href="https://wa.me/13137768220"
            target="_blank"
            class="icon whatsapp"
            ><i class="fab fa-whatsapp"></i
          ></a>
          <a href="https://twitter.com" target="_blank" class="icon twitter"
            ><i class="fab fa-x-twitter"></i
          ></a>
          <a
            href="https://instagram.com"
            target="_blank"
            class="icon instagram"
            ><i class="fab fa-instagram"></i
          ></a>
        </div>
        <div><a href="security.html">Security & Protection</a></div>

        <p class="copyright">&copy; 2025 TradeXInvest. All rights reserved.</p>
      </div>
    </footer>
<script>
// Function to toggle mobile nav
function toggleMobileNav() {
  const mobileMenu = document.getElementById("mobileMenu");
  if (!mobileMenu) return; // prevent error if element not found
  mobileMenu.classList.toggle("show"); // toggles the 'show' class
}

// Expose globally if using inline onclick
window.toggleMobileNav = toggleMobileNav;

const backendUrl = "https://tradexinvestments.onrender.com"; 
let countdownTimer = null;

/* ===========================
   HELPERS: MODALS & STATE
=========================== */
const overlay = document.getElementById("overlay");
function openModal(id){
  overlay.style.display = "block";
  document.getElementById(id).style.display = "block";
}
function closeModal(id){
  const el = document.getElementById(id);
  if(el) el.style.display = "none";
  // If no other modal is open, hide overlay
  const anyOpen = [...document.querySelectorAll(".modal")].some(m => m.style.display === "block");
  if(!anyOpen) overlay.style.display = "none";
}
overlay.addEventListener("click", ()=>{
  document.querySelectorAll(".modal").forEach(m=>m.style.display="none");
  overlay.style.display="none";
});
document.querySelectorAll("[data-close]").forEach(btn=>{
  btn.addEventListener("click", ()=> closeModal(btn.getAttribute("data-close")));
});

function currency(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
function setSession(user, jwt){
  if(user) localStorage.setItem("currentUser", JSON.stringify(user));
  if(jwt)  localStorage.setItem("jwtToken", jwt);
}
function clearSession(){
  localStorage.clear();
}

/* ===========================
   SLIDERS
=========================== */
(function sliders(){
  const imgs = document.querySelectorAll("#welcomeNote img");
  const quotes = document.querySelectorAll("#quotes p");
  let i=0, q=0;
  function showImg(k){ imgs.forEach((im,idx)=>im.classList.toggle("active", idx===k)); }
  function showQuote(k){ quotes.forEach((p,idx)=>p.classList.toggle("active", idx===k)); }
  showImg(0); showQuote(0);
  setInterval(()=>{ i=(i+1)%imgs.length; showImg(i); }, 3000);
  setInterval(()=>{ q=(q+1)%quotes.length; showQuote(q); }, 3000);
})();

/* ===========================
   SIGNUP
=========================== */
document.getElementById("openSignup").onclick = ()=> openModal("signupModal");
document.getElementById("ctaSignup").onclick  = ()=> openModal("signupModal");

document.getElementById("signupSubmit").addEventListener("click", async ()=>{
  const name = document.getElementById("suName").value.trim();
  const email = document.getElementById("suEmail").value.trim();
  const password = document.getElementById("suPassword").value.trim();
  if(!name || !email || !password) return alert("Fill in all fields");

  try{
    const res = await fetch(`${backendUrl}/api/auth/signup`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ name, email, password })
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.msg || "Signup failed");
    alert("Signup successful! Please login.");
    closeModal("signupModal");
    // Prefill login email
    document.getElementById("liEmail").value = email;
    openModal("loginModal");
  }catch(err){ alert(err.message); }
});

/* ===========================
   LOGIN ‚Üí TERMS ‚Üí 2FA ‚Üí DASHBOARD
=========================== */
document.getElementById("openLogin").onclick = ()=> openModal("loginModal");
document.getElementById("ctaLogin").onclick  = ()=> openModal("loginModal");



// ----- LOGIN / TERMS / 2FA -----
document.getElementById("loginSubmit").addEventListener("click", async () => {
  const email = document.getElementById("loginEmail")?.value.trim();
  const password = document.getElementById("loginPassword")?.value.trim();

  if (!email || !password) {
    console.log("Login: Missing email or password");
    return alert("Enter email & password");
  }

  console.log("Login: Sending credentials", { email });

  try {
    const res = await fetch(`${backendUrl}/api/auth/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });

    const text = await res.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch {
      console.error("Login: Invalid JSON response", text);
      throw new Error("Invalid JSON from server");
    }

    if (!res.ok) {
      console.error("Login failed", data);
      throw new Error(data.msg || "Login failed");
    }

    console.log("Login successful", data);
    localStorage.setItem("currentUser", JSON.stringify(data));

    // Show terms popup
    openTermsPopup();

  } catch (err) {
    console.error("Login error:", err);
    alert(err.message);
  }
});

// TERMS POPUP
function openTermsPopup() {
  console.log("Showing terms popup");
  const termsPopup = document.getElementById("termsPopup");
  termsPopup.style.display = "block";

  document.getElementById("acceptTermsBtn").onclick = () => {
    console.log("Terms accepted");
    localStorage.setItem("termsAccepted", "true");
    termsPopup.style.display = "none";
    open2FAPopup();
  };
}

// 2FA POPUP
function open2FAPopup() {
  console.log("Showing 2FA popup");
  const popup = document.getElementById("twoFAPopup");
  popup.style.display = "block";
  startCountdown();

  document.getElementById("verify2FABtn").onclick = async () => {
    const code = document.getElementById("twoFAInput").value.trim();
    const user = JSON.parse(localStorage.getItem("currentUser"));
    if (!code) return alert("Enter 2FA code");

    console.log("Verifying 2FA code", code);

    try {
      const res = await fetch(`${backendUrl}/api/auth/verify-2fa`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code, tempToken: user.tempToken })
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.msg);

      console.log("2FA verified", data);
      localStorage.setItem("twoFAVerified", "true");
      localStorage.setItem("jwtToken", data.token);

      popup.style.display = "none";
      showUserDashboard(user);

    } catch (err) {
      console.error("2FA verification error:", err);
      alert(err.message);
    }
  };
}


// ----- 2FA COUNTDOWN -----
function startCountdown(duration=300) {
  clearInterval(countdownTimer);
  const el = document.getElementById("countdown");
  let timeLeft = duration;
  el.textContent = `Code expires in: ${formatTime(timeLeft)}`;
  document.getElementById("verify2FABtn").disabled = false;

  countdownTimer = setInterval(() => {
    timeLeft--;
    el.textContent = `Code expires in: ${formatTime(timeLeft)}`;
    if(timeLeft<=0){
      clearInterval(countdownTimer);
      el.textContent = "Code expired. Please resend.";
      document.getElementById("verify2FABtn").disabled = true;
    }
  }, 1000);
}
function formatTime(sec){ return `${Math.floor(sec/60)}:${(sec%60<10?"0":"")+sec%60}`; }

// ----- DASHBOARD -----
// After user login + 2FA verification
async function showUserDashboard(user) {
  const jwt = localStorage.getItem("jwtToken");
  try {
    const res = await fetch(`${backendUrl}/api/user/me`, {
      headers: { "Authorization": `Bearer ${jwt}` }
    });
    const me = await res.json();
    if (!res.ok) throw new Error(me.msg || "Failed to load profile");

    localStorage.setItem("currentUser", JSON.stringify(me));

    // Show regular dashboard
    document.getElementById("dashboardCard").classList.remove("hidden");
    document.getElementById("logoutTop").classList.remove("hidden");
    document.getElementById("welcomeUser").textContent = `Welcome, ${me.name || "Investor"}`;
    document.getElementById("statBalance").textContent  = currency(me.investment);
    document.getElementById("statProfit").textContent   = currency(me.profit);
    document.getElementById("statInterest").textContent = currency(me.totalInterest);

    // If user is admin, show admin nav button
    if (me.role === "admin" || me.isAdmin) {
      console.log("Admin detected, showing admin nav");
      document.getElementById("openAdmin").classList.remove("hidden");

      // Optional: automatically load admin panel
      document.getElementById("openAdmin").onclick = async () => {
        document.getElementById("adminCard").classList.remove("hidden");
        document.getElementById("dashboardCard").classList.add("hidden");
        await loadAdminUsers();
        await loadAdminWithdrawals();
      };
    }

  } catch (err) {
    console.error("Dashboard load error:", err);
    alert(err.message);
  }
}

// Optional: quick check to auto-show admin if JWT + 2FA and role is admin
window.addEventListener("DOMContentLoaded", async () => {
  const jwt = localStorage.getItem("jwtToken");
  const twoFA = localStorage.getItem("twoFAVerified");
  const user = JSON.parse(localStorage.getItem("currentUser"));
  console.log("Auto-check admin on load:", user?.role);

  if (jwt && twoFA === "true" && (user?.role === "admin" || user?.isAdmin)) {
    document.getElementById("openAdmin").click(); // auto-open admin card
  }
});


// ----- ADMIN -----
const adminCard = document.getElementById("adminCard");
document.getElementById("openAdmin").onclick = async () => {
  adminCard.classList.remove("hidden");
  await loadAdminUsers();
  await loadAdminWithdrawals();
};
document.getElementById("openDashboard").onclick = ()=> {
  adminCard.classList.add("hidden");
  document.getElementById("dashboardCard").classList.remove("hidden");
};

document.querySelectorAll(".tabs button").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.getAttribute("data-tab");
    document.getElementById("usersTab").classList.toggle("hidden", tab!=="usersTab");
    document.getElementById("withdrawalsTab").classList.toggle("hidden", tab!=="withdrawalsTab");
  });
});

async function loadAdminUsers(){
  try{
    const token = localStorage.getItem("jwtToken");
    const res = await fetch(`${backendUrl}/api/admin/users`, { headers:{ "Authorization": `Bearer ${token}` }});
    const data = await res.json();
    if(!res.ok) throw new Error(data.msg || "Failed to load users");
    const tbody = document.getElementById("adminUsersBody");
    tbody.innerHTML = "";
    data.forEach(u=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.name||"-"}</td>
        <td>${u.email}</td>
        <td>$${u.investment}</td>
        <td>$${u.profit}</td>
        <td>
          <div class="row">
            <input type="number" step="0.01" placeholder="Add profit" data-profit-for="${u._id}" />
            <button class="btn btn-primary" data-save-profit="${u._id}">Add</button>
          </div>
        </td>`;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("[data-save-profit]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-save-profit");
        const val = parseFloat(tbody.querySelector(`[data-profit-for="${id}"]`).value);
        if(isNaN(val)||val<=0) return alert("Enter profit to add");
        try{
          const res = await fetch(`${backendUrl}/api/admin/users/${id}`,{
            method:"PATCH",
            headers:{ "Content-Type":"application/json", "Authorization": `Bearer ${localStorage.getItem("jwtToken")}` },
            body: JSON.stringify({ profitDelta: val })
          });
          const data = await res.json();
          if(!res.ok) throw new Error(data.msg || "Failed to update profit");
          alert("Profit updated");
          await loadAdminUsers();
        }catch(err){ alert(err.message); }
      });
    });
  }catch(err){ alert(err.message); }
}

async function loadAdminWithdrawals(){
  try{
    const token = localStorage.getItem("jwtToken");
    const res = await fetch(`${backendUrl}/api/admin/withdrawals`, { headers:{ "Authorization": `Bearer ${token}` }});
    const data = await res.json();
    if(!res.ok) throw new Error(data.msg || "Failed to load withdrawals");
    const tbody = document.getElementById("adminWdBody");
    tbody.innerHTML = "";
    data.forEach(w=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${w.user?.email||"-"}</td>
        <td>${w.method}</td>
        <td>$${w.amount}</td>
        <td>${w.status}</td>
        <td class="row">
          <button class="btn btn-primary" data-approve="${w._id}">Approve</button>
          <button class="btn btn-danger" data-reject="${w._id}">Reject</button>
        </td>`;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("[data-approve]").forEach(btn=> btn.addEventListener("click", ()=> handleWd(btn.getAttribute("data-approve"), "approve")));
    tbody.querySelectorAll("[data-reject]").forEach(btn=> btn.addEventListener("click", ()=> handleWd(btn.getAttribute("data-reject"), "reject")));
  }catch(err){ alert(err.message); }
}

async function handleWd(id, action){
  try{
    const token = localStorage.getItem("jwtToken");
    const res = await fetch(`${backendUrl}/api/admin/withdrawals/${id}/${action}`, { method:"POST", headers:{ "Authorization": `Bearer ${token}` }});
    const data= await res.json();
    if(!res.ok) throw new Error(data.msg || "Action failed");
    alert(`Withdrawal ${action}d`);
    await loadAdminWithdrawals();
  }catch(err){ alert(err.message); }
}

// ----- UTILS -----
function currency(val){ return parseFloat(val||0).toFixed(2); }
</script>

  
</body>
</html>

