<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TradeXinvest</title>
  <link rel="stylesheet" href="style.css" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  />
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    .testimonials-section {
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 1rem;
      font-family: Arial, sans-serif;
    }
    .testimonials-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      justify-content: center;
    }
    .testimonial-box {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 1.5rem;
      flex: 1 1 280px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    .testimonial-box p {
      font-size: 1.1rem;
      color: #555;
      margin: 1rem 0 0.8rem;
    }
    .testimonial-box h4 {
      color: #555;
      font-weight: 600;
      margin: 0;
    }
    .stars {
      font-size: 1.3rem;
      color: #f5a623; /* gold star color */
      user-select: none;
    }
    .stars span {
      letter-spacing: 2px;
    }
    .profile-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .profile-info img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ddd;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .profile-info h3 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
    }
    /* Hide withdraw form by default */
    .withdraw-form.hidden {
      display: none;
    }
    /* Chat widget styles */
    .chat-widget {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      max-height: 400px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      font-family: Arial, sans-serif;
      display: none; /* hidden by default */
      z-index: 10000;
    }
    .chat-header {
      background: #007bff;
      color: white;
      padding: 10px;
      font-weight: bold;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
    }
    .chat-body {
      flex-grow: 1;
      padding: 10px;
      overflow-y: auto;
      background: #f9f9f9;
    }
    .message {
      margin-bottom: 8px;
      padding: 6px 10px;
      border-radius: 12px;
      max-width: 80%;
      word-wrap: break-word;
    }
    .message.user {
      background: #d1e7dd;
      align-self: flex-end;
    }
    .message.admin {
      background: #f8d7da;
      align-self: flex-start;
    }
    .message.system {
      background: #e2e3e5;
      font-style: italic;
      color: #555;
      align-self: center;
      max-width: 90%;
    }
    #chatForm {
      display: flex;
      border-top: 1px solid #ddd;
    }
    #chatInput {
      flex-grow: 1;
      border: none;
      padding: 10px;
      font-size: 1rem;
      border-radius: 0 0 0 8px;
      outline: none;
    }
    #chatForm button {
      border: none;
      background: #007bff;
      color: white;
      padding: 0 20px;
      cursor: pointer;
      border-radius: 0 0 8px 0;
    }
    :root{
    --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --brand:#22c55e; --danger:#ef4444;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .container{max-width:1100px;margin:0 auto;padding:24px}
  .grid{display:grid;gap:16px}
  .two{grid-template-columns:1fr 1fr}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  h1,h2,h3{margin:.4em 0}
  input,select,button,textarea{
    width:100%;padding:12px 14px;border-radius:12px;border:1px solid #253041;background:#0b1220;color:var(--text);
    outline:none
  }
  input::placeholder{color:#6b7280}
  button{cursor:pointer;transition:transform .05s ease, opacity .15s ease}
  button:hover{opacity:.95}
  .btn{background:#1f2937}
  .btn-primary{background:var(--brand);color:#052e16;border:none}
  .btn-danger{background:var(--danger);border:none}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .row>.grow{flex:1}
  .muted{color:var(--muted);font-size:.9rem}
  .hidden{display:none !important}

  /* Overlay + Modal */
  #overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter: blur(2px);z-index:1000}
  .modal{display:none;position:fixed;inset:auto;top:50%;left:50%;transform:translate(-50%,-50%);
    background:#0b1220;border:1px solid #26334d;border-radius:16px;padding:20px;z-index:1001;min-width:min(92vw,520px)}
  .modal h3{margin-top:0}
  .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}

  /* Tables */
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #1f2937;text-align:left}
  th{color:#9ca3af;font-weight:600}

  /* Header */
  .topbar{position:sticky;top:0;background:rgba(15,23,42,.7);backdrop-filter:blur(6px);border-bottom:1px solid #1f2937;z-index:50}
  .topbar-inner{display:flex;align-items:center;justify-content:space-between;padding:12px 24px}
  .brand{font-weight:700;letter-spacing:.3px}
  .pill{padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid #1f2937}

  /* Stat cards */
  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .stat{background:#0b1220;border:1px solid #1f2937;border-radius:14px;padding:16px}
  .stat .label{color:#94a3b8;font-size:.9rem}
  .stat .value{font-size:1.4rem;font-weight:700;margin-top:6px}

  /* Sliders */
  #welcomeNote img{display:none;width:100%;max-height:180px;object-fit:cover;border-radius:12px;border:1px solid #1f2937}
  #welcomeNote img.active{display:block}
  #quotes p{display:none;font-style:italic;margin:0}
  #quotes p.active{display:block}

  /* Admin tabs */
  .tabs{display:flex;gap:8px;margin-bottom:10px}
  .tabs button{padding:8px 12px;border-radius:10px}
  .tabs button.active{background:#19324f}

  /* Tiny helper */
  .right{float:right}
  #dashboardSection {
  display: none;
}
#termsModal, #twoFAModal {
  display: none;
}
/* CSS */
/* #adminLoginModal {
  display: none;
}
#adminLoginModal.active {
  display: block;
} */


  </style>
</head>
<body>
  <div class="lowerNAV" onclick="toggleMobileNav()">
    <div style="display: flex; flex-direction: column; gap: 4px;">
      <span style="width: 30px; height: 4px; background-color: black;"></span>
      <span style="width: 30px; height: 4px; background-color: black;"></span>
      <span style="width: 30px; height: 4px; background-color: black;"></span>
    </div>
  </div>

  <ul class="mobile-menu" id="mobileMenu">
    <li><a href="index.html">Home</a></li>
    <li><a href="about.html">About Us</a></li>
    <li><a href="contact.html">Contact</a></li>
  </ul> 
   <div class="nav">
    <p class="logo">TradeXInvest</p>
    

    </div>
    

<!-- end of dashboard -->
 <!-- Topbar -->
<div class="topbar">
  <div class="topbar-inner container">
    <div class="brand">TradexInvest</div>
    <div class="row">
      <button id="openLogin" class="pill">Login</button>
      <button id="openSignup" class="pill">Sign Up</button>
      <button id="openDashboard" class="pill hidden">Dashboard</button>
      <button id="openAdminLogin" class="pill ">Admin</button>
      <button id="logoutTop" class="pill hidden">Logout</button>
      
    </div>
  </div>
</div>
  <div class="card">
      <h3>Welcome</h3>
      <div id="welcomeNote">
        <img src="https://picsum.photos/seed/a/1100/280" class="active" alt="">
        <img src="https://picsum.photos/seed/b/1100/280" alt="">
        <img src="https://picsum.photos/seed/c/1100/280" alt="">
      </div>
      <div style="margin-top:12px" id="quotes">
        <p class="active">“Invest smart, live better.”</p>
        <p>“Your future starts today.”</p>
        <p>“Profit is a journey, not a destination.”</p>
      </div>
    </div>

<div class="container grid two">

  <!-- Public / left column -->
  <div class="grid">
    <div class="card">
      <h2>Get started</h2>
      <p class="muted">Create an account, log in, accept the terms, verify 2FA, then manage your investments — all on this page.</p>
      <div class="row">
        <button id="ctaSignup" class="btn btn-primary">Create account</button>
        <button id="ctaLogin" class="btn">I already have an account</button>
      </div>
    </div>
</div>
    

  <!-- Dashboard / right column -->
  <div class="grid">
    <!-- ================= Admin Dashboard ================= -->
<div id="adminDashboard" class="card hidden">
  <h2>Admin Dashboard</h2>
  <button id="logoutAdmin" class="btn">Logout</button>

  <!-- Tabs -->
  <div class="tabs">
    <button data-tab="usersTab" class="btn active">Users</button>
    <button data-tab="withdrawalsTab" class="btn">Withdrawals</button>
  </div>
  


  <!-- Users Tab -->
  <div id="usersTab">
    <h3>Manage Users</h3>
    <table>
      <thead>
        <tr>
          <th>Name</th><th>Email</th><th>Balance</th><th>Profit</th><th>Interest</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="adminUsersBody"></tbody>
    </table>
  </div>

  <!-- Withdrawals Tab -->
  <div id="withdrawalsTable" class="hidden">
    <h3>Manage Withdrawals</h3>
    <table>
      <thead>
        <tr>
          <th>User</th><th>Method</th><th>Amount</th><th>Status</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="adminWdBody"></tbody>
    </table>
  </div>
</div>

<!-- ================= Edit User Modal ================= -->
<div id="updateUserForm" class="modal hidden">
  <div class="modal-content">
    <h3>Edit User</h3>
    <label>Name <input type="text" id="editName" /></label>
    <label>Email <input type="email" id="editEmail" /></label>
    <label>Balance <input type="number" id="editBalance" /></label>
    <label>Profit <input type="number" id="editProfit" /></label>
    <label>Interest <input type="number" id="editInterest" /></label>
    <button id="saveUserBtn" class="btn">Save</button>
    <button onclick="closeModal('editUserModal')" class="btn">Cancel</button>
  </div>
</div>


<div class="grid">
<!-- Dashboard Card -->
<div id="dashboardCard" class="hidden p-6 bg-white shadow rounded-lg max-w-4xl mx-auto mt-8">
  <button id="openDashboard" class="btn btn-primary">Go to Dashboard</button>
  <div class="mb-6 flex justify-between items-center">
    <h2 id="welcomeUser" class="text-xl font-bold">Welcome, User</h2>
    <button id="logoutTop" class="px-4 py-2 bg-red-500 text-white rounded hidden">Logout</button>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-3 gap-4 mb-6">
    <div class="p-4 bg-gray-100 rounded">
      <p class="text-sm text-gray-500">Balance</p>
      <p id="statBalance" class="text-lg font-semibold">$0.00</p>
    </div>
    <div class="p-4 bg-gray-100 rounded">
      <p class="text-sm text-gray-500">Profit</p>
      <p id="statProfit" class="text-lg font-semibold">$0.00</p>
    </div>
    <div class="p-4 bg-gray-100 rounded">
      <p class="text-sm text-gray-500">Interest</p>
      <p id="statInterest" class="text-lg font-semibold">$0.00</p>
    </div>
  </div>

  <!-- Buttons -->
  <div class="mb-6 flex gap-4">
    <button id="depositBtn" class="px-4 py-2 bg-green-500 text-white rounded">Deposit</button>
    <button id="withdrawBtn" class="px-4 py-2 bg-yellow-500 text-white rounded">Withdraw</button>
  </div>

  <!-- Transactions -->
  <div class="overflow-x-auto">
    <table class="w-full border-collapse border border-gray-300">
      <thead class="bg-gray-200">
        <tr>
          <th class="border border-gray-300 px-3 py-2">Date</th>
          <th class="border border-gray-300 px-3 py-2">Type</th>
          <th class="border border-gray-300 px-3 py-2">Amount</th>
          <th class="border border-gray-300 px-3 py-2">Status</th>
        </tr>
      </thead>
      <tbody id="txTable">
        <tr>
          <td colspan="4" class="text-center py-4">No transactions yet.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Deposit Modal -->
<div id="depositModal" class="modal hidden">
  <h3>Deposit</h3>
  <input id="depositAmount" placeholder="Amount (USD)" />
  <div class="actions mt-4">
    <button class="btn" data-close="depositModal">Close</button>
    <button id="submitDeposit" class="btn btn-primary">Deposit</button>
  </div>
</div>

<!-- Withdraw Modal -->
<div id="withdrawModal" class="modal hidden">
  <h3>Withdraw</h3>
  <input id="withdrawAmount" placeholder="Amount (USD)" />
  <select id="withdrawMethod" class="mt-2">
    <option value="bank">Bank-to-Bank</option>
    <option value="paypal">PayPal</option>
    <option value="bitcoin">Bitcoin</option>
    <option value="cashapp">CashApp</option>
  </select>
  <div class="actions mt-4">
    <button class="btn" data-close="withdrawModal">Close</button>
    <button id="submitWithdraw" class="btn btn-primary">Request Withdraw</button>
  </div>
</div>

</div>


    
  </div>
</div>

<!-- ===== Overlay + Modals ===== -->
<div id="overlay"  > </div>


<div id="signupModal" class="modal">
  <h3>Create account</h3>
  <div class="row">
    <input id="suName" placeholder="Full name" class="grow" />
    <input id="suEmail" placeholder="Email" class="grow" />
  </div>
  <div class="row" style="margin-top:10px">
    <input id="suPassword" placeholder="Password" type="password" class="grow" />
  </div>
  <div class="actions">
    <button class="btn" data-close="signupModal">Cancel</button>
    <button id="signupSubmit" class="btn btn-primary">Sign Up</button>
  </div>
</div>
<!-- Admin Login Button (hidden for regular users) -->

<div id="adminLoginModal" class="modal ">
  <h3>Admin Login</h3>
  <input id="adminEmail" type="email" placeholder="Admin Email" />
  <input id="adminPassword" type="password" placeholder="Password" />
  <button id="adminLoginSubmit">Login</button>
  <button onclick="closeModal('adminLoginModal')">Cancel</button>
</div>

<!-- Login Modal -->
<div id="loginModal" class="modal">
  <h3>Login</h3>
  <input type="email" id="liEmail" placeholder="Email" />
  <div style="height:8px"></div>
  <input  id="liPassword" placeholder="Password" type="password" />
  <input type="hidden" id="loginType" value="admin"> 
  <div class="actions">
    <button class="btn" data-close="loginModal">Cancel</button>
    <button id="loginSubmit" class="btn btn-primary">Login</button>
  </div>
</div>

<!-- Terms Modal -->
<!-- Terms Modal -->
<div id="termsModal" class="modal">
  <h3>Terms & Conditions</h3>
  <div style="max-height:220px;overflow:auto;border:1px solid #1f2937;border-radius:10px;padding:12px">
    <p class="muted">By continuing, you agree to our terms regarding investments, risk disclosure, and platform policies.</p>
    <ul class="muted">
      <li>Investments involve risk of loss.</li>
      <li>Profits shown are indicative and not guaranteed.</li>
      <li>We may require identity verification for withdrawals.</li>
    </ul>
  </div>
  <div class="actions">
    <button class="btn" data-close="termsModal">Decline</button>
    <button id="acceptTermsBtn" class="btn btn-primary">I Accept</button>
  </div>
</div>

<!-- 2FA Modal -->
<div id="twoFAModal" class="modal">
  <h3>Two-Factor Verification</h3>
  <p class="muted" id="twofaHint">We’ve emailed a 6-digit code to your address.</p>
  <input id="twofaCode" placeholder="Enter 2FA code" />
  <div class="row" style="align-items:center;margin-top:8px">
    <div id="countdown" class="muted">Code expires in 5:00</div>
    <button id="resend2FA" class="btn right">Resend code</button>
  </div>
  <div class="actions">
    <button class="btn" data-close="twoFAModal">Cancel</button>
    <button id="verify2FA" class="btn btn-primary">Verify</button>
  </div>
</div>



    
<!-- end  -->
    <div id="welcomeNote" class="welcomeNote">
      <img src="images/photo 5.avif" alt="img" />
      <img src="images/stock 1.webp" alt="img" />
      <img src="images/photo 7.avif" alt="img" />
      <img src="images/photo-1749741326969-e1676b3bce43.avif" alt="img" />
    </div>
    <div id="qoutes" class="qoutes">
      <p> WE ARE TRADEX</p>
      <p>"Do not save what is left after spending, but spend what is left after saving."</p>
      <p>"An investment in knowledge pays the best interest."</p>
      <p>"Successful investing is about managing risk, not avoiding it."</p>
    </div>
    <section id="features" class="features-section">
      <h2>Our Features</h2>
      <div class="features-container">
        <div class="feature-box">
          <i class="fa fa-shield-alt"></i>
          <h3>Secure Platform</h3>
          <p>
            We use top-level security to keep your data and transactions safe at
            all times.
          </p>
        </div>
        <div class="feature-box">
          <i class="fa fa-chart-line"></i>
          <h3>Live Investment Tracking</h3>
          <p>
            View real-time updates of your investment, profit, and total interest
            on your dashboard.
          </p>
        </div>
        <div class="feature-box">
          <i class="fa fa-hand-holding-usd"></i>
          <h3>Flexible Investment Plans</h3>
          <p>
            Choose from a variety of plans that suit your goals and budget with
            high returns.
          </p>
        </div>
        <div class="feature-box">
          <i class="fa fa-headset"></i>
          <h3>24/7 Support</h3>
          <p>
            Our dedicated support team is always here to help you through live
            chat or email.
          </p>
        </div>
      </div>
    </section>
    <div class="live-counter">
      <h3>Total Interest Growing:</h3>
      <p>$<span id="interestCounter">0.00</span></p>
    </div>
    <div class="countdown-box">
      <h3>Next Payout In:</h3>
      <p id="payoutCountdown">Loading...</p>
    </div>
    <section id="whyChooseUs" class="why-section">
      <h2>Why Choose TradeXInvest</h2>
      <div class="why-container">
        <div class="why-box">
          <i class="fa fa-users"></i>
          <h3>Trusted by Thousands</h3>
          <p>
            Over 10,000 investors trust us with their money, and our reviews speak
            for themselves.
          </p>
        </div>
        <div class="why-box">
          <i class="fa fa-bolt"></i>
          <h3>Fast & Easy</h3>
          <p>
            Sign up and start investing in just minutes. User-friendly and
            accessible from any device.
          </p>
        </div>
        <div class="why-box">
          <i class="fa fa-award"></i>
          <h3>Proven Results</h3>
          <p>
            We’ve consistently delivered strong returns for our investors with
            transparent performance.
          </p>
        </div>
      </div>
    </section>
    <section class="hero-section">
      <div class="hero-content">
        <h1>Invest Smart with TradeXInvest</h1>
        <p>
          Your trusted platform to grow wealth with secure and high-yield
          investment plans.
        </p>
        <div class="hero-buttons">
           <button id="ctaSignup" class="btn btn-primary">Create account</button>
          <a href="#features" class="btn-secondary">Learn More</a>
        </div>
      </div>
      <div class="hero-image">
        <img src="images/photo 5.webp" alt="Investment Image" />
      </div>
    </section>

    <section id="testimonials" class="testimonials-section">
      <h2>What Our Investors Say......</h2>
      <div class="testimonials-container">
        <div class="testimonial-box">
          <div class="stars" aria-label="Rating: 5 out of 5 stars">
            <span>⭐️⭐️⭐️⭐️⭐️</span>
          </div>
          <p>
            "TradeXInvest helped me grow my savings steadily. The dashboard is
            simple, and the support team is amazing!"
          </p>
          <h4>— Sarah U., Australia</h4>
        </div>
        <div class="testimonial-box">
          <div class="stars" aria-label="Rating: 4.5 out of 5 stars">
            <span>⭐️⭐️⭐️⭐️⭐️</span>
          </div>
          <p>
            "I was skeptical at first, but now I’m earning consistent interest on
            my investment. I recommend it 100%!"
          </p>
          <h4>— James Eudardo., Brazil</h4>
        </div>
        <div class="testimonial-box">
          <div class="stars" aria-label="Rating: 4 out of 5 stars">
            <span>⭐️⭐️⭐️⭐️⭐️</span>
          </div>
          <p>
            "What I love is the transparency. I see my profits in real time and
            the withdrawals are smooth."
          </p>
          <h4>— Anita O., New Jersey</h4>
        </div>
      </div>
    </section>

    <section class="cta-section">
      <h2>Ready to Grow Your Wealth?</h2>
      <p>Join thousands of investors earning passive income with TradeXInvest.</p>
      <p> <button id="ctaSignup" class="btn btn-primary">Get Started Now</button></p>
    </section>

    <!-- Chat widget -->
    <div id="chatWidget" class="chat-widget">
      <div
        class="chat-header"
        onclick="document.getElementById('chatWidget').style.display='none';"
      >
        💬 Chat With Us (Click header to close)
      </div>
      <div class="chat-body" id="chatBody">
        <div class="message admin">
          Hi TradeX 👋, want help choosing the best plan?
        </div>
      </div>
      <form id="chatForm">
        <input
          type="text" 
          id="chatInput"
          placeholder="Type your message..."
          autocomplete="off"
        />
        <button type="submit">Send</button>
      </form>
    </div>

    <footer class="site-footer">
      <div class="footer-content">
        <h2>TradeXInvest</h2>
        <p>Secure and smart investment platform to grow your wealth.</p>

        <!-- 🔗 Contact Info -->
        <div class="contact-info">
          <p>
            <i class="fas fa-envelope"></i>
            <p>Need help? Contact our support team at</p>
            <a href="support@tradexinvest.net">support@tradexinvest.net</a>
          </p>
          <p>
            <i class="fas fa-phone"></i>
            <a href="https://wa.me/+13137768220">+13137768220</a>
          </p>
          <p>
            <i class="fas fa-paper-plane"></i>
            <a href="contact.html">Send Us a Message</a>
          </p>
        </div>

        <!-- 🔗 Social Media -->
        <div class="social-icons">
          <a
            href="https://signal.me/#eu/B0bK1TWO1rDFGcCqWeraUIdHqG29QV04qxhVbyN4zxW5N3TXSEtPwY6Dcy9JaDGm"
            target="_blank"
            class="icon facebook"
            ><i class="fab fa-facebook-f"></i
          ></a>
          <a
            href="https://wa.me/13137768220"
            target="_blank"
            class="icon whatsapp"
            ><i class="fab fa-whatsapp"></i
          ></a>
          <a href="https://twitter.com" target="_blank" class="icon twitter"
            ><i class="fab fa-x-twitter"></i
          ></a>
          <a
            href="https://instagram.com"
            target="_blank"
            class="icon instagram"
            ><i class="fab fa-instagram"></i
          ></a>
        </div>
        <div><a href="security.html">Security & Protection</a></div>

        <p class="copyright">&copy; 2025 TradeXInvest. All rights reserved.</p>
      </div>
      

    </footer>
    <script>
document.addEventListener("DOMContentLoaded", () => {
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);
  const backendUrl = "https://www.tradexinvest.net";

  // ---------- helpers ----------
  const token = () => localStorage.getItem("jwtToken") || "";
  const tempToken = () => localStorage.getItem("jwtTemp") || "";
  const authHeaders = () => ({
    "Content-Type": "application/json",
    Authorization: `Bearer ${token()}`
  });
  const fmtMoney = (n) => `$${Number(n).toFixed(2)}`;

  // ---------- modal helpers ----------
  function openModal(id) { $(id).classList.remove("hidden"); $("#overlay").style.display = "block"; }
  function closeModal(id) { $(id).classList.add("hidden"); $("#overlay").style.display = "none"; }

  // ---------- Global state ----------
  let currentUser = null;

  // ---------- Terms ----------
  $("#acceptTermsBtn")?.addEventListener("click", async () => {
    try {
      const res = await fetch(`${backendUrl}/accept-terms`, { method: "POST", headers: { Authorization: `Bearer ${tempToken()}` }});
      const data = await res.json();
      if (!data.success) return alert(data.message);
      closeModal("#termsModal");
      openModal("#twoFAModal");
      start2FACountdown();
    } catch (err) { console.error(err); }
  });

  // ---------- 2FA ----------
  let countdownInterval;
  function start2FACountdown(duration = 300) {
    clearInterval(countdownInterval);
    const countdownEl = $("#countdown");
    let timeLeft = duration;
    function updateDisplay() {
      const min = Math.floor(timeLeft / 60).toString().padStart(2, "0");
      const sec = (timeLeft % 60).toString().padStart(2, "0");
      countdownEl.textContent = `Code expires in ${min}:${sec}`;
    }
    updateDisplay();
    countdownInterval = setInterval(() => {
      timeLeft--;
      updateDisplay();
      if (timeLeft <= 0) {
        clearInterval(countdownInterval);
        alert("2FA code expired. Please login again.");
        closeModal("#twoFAModal");
        localStorage.removeItem("jwtTemp");
      }
    }, 1000);
  }

  $("#verify2FA")?.addEventListener("click", async () => {
    const code = $("#twofaCode").value;
    if (!code) return alert("Enter 2FA code");
    try {
      const res = await fetch(`${backendUrl}/verify-2fa`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${tempToken()}` },
        body: JSON.stringify({ code })
      });
      const data = await res.json();
      if (!data.success) return alert(data.message);
      localStorage.setItem("jwtToken", data.token);
      localStorage.removeItem("jwtTemp");
      currentUser = data.user;
      closeModal("#twoFAModal");
      showUserDashboard();
    } catch (err) { console.error(err); }
  });

  $("#resend2FA")?.addEventListener("click", async () => {
    alert("Resend feature requires re-login"); 
  });

  // ---------- Login ----------
  $("#loginSubmit")?.addEventListener("click", async () => {
    const email = $("#liEmail").value;
    const password = $("#liPassword").value;
    if (!email || !password) return alert("Enter email & password");
    try {
      const res = await fetch(`${backendUrl}/user-login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
      });
      const data = await res.json();
      if (!data.success) return alert(data.message);
      if (data.requiresTerms) openModal("#termsModal");
      else if (data.requires2FA) {
        localStorage.setItem("jwtTemp", data.tempToken);
        openModal("#twoFAModal");
        start2FACountdown();
      }
    } catch (err) { console.error(err); }
  });

  // ---------- Signup ----------
  $("#signupSubmit")?.addEventListener("click", async () => {
    const name = $("#suName").value;
    const email = $("#suEmail").value;
    const password = $("#suPassword").value;
    if (!name || !email || !password) return alert("Fill all fields");
    try {
      const res = await fetch(`${backendUrl}/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, email, password })
      });
      const data = await res.json();
      if (!data.success) return alert(data.message);
      alert("Account created. Please login.");
      closeModal("#signupModal");
    } catch (err) { console.error(err); }
  });

  // ---------- User Dashboard ----------
  async function showUserDashboard() {
    try {
      const res = await fetch(`${backendUrl}/current-user`, { headers: authHeaders() });
      const data = await res.json();
      if (!data.success) return alert(data.message);
      currentUser = data.user;

      $("#dashboardSection").style.display = "block";
      $("#welcomeUser").textContent = `Welcome, ${currentUser.name}`;

      const inv = currentUser.investment || { balance: 0, profit: 0, interest: 0 };
      $("#statBalance").textContent = fmtMoney(inv.balance);
      $("#statProfit").textContent = fmtMoney(inv.profit);
      $("#statInterest").textContent = fmtMoney(inv.interest);

      // Render transaction history
      const txTable = $("#txTable");
      txTable.innerHTML = "";
      const txHistory = currentUser.transactions || [];
      if (!txHistory.length) txTable.innerHTML = `<tr><td colspan="4" class="text-center py-4">No transactions yet.</td></tr>`;
      else txHistory.forEach(tx => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${new Date(tx.date).toLocaleString()}</td><td>${tx.type}</td><td>${fmtMoney(tx.amount)}</td><td>${tx.status}</td>`;
        txTable.appendChild(tr);
      });
    } catch (err) { console.error(err); }
  }

  // ---------- Deposit ----------
  $("#depositBtn")?.addEventListener("click", async () => {
    const amount = parseFloat(prompt("Deposit amount:"));
    if (!amount || amount <= 0) return alert("Invalid amount");
    await updateUserInvestment(amount, "deposit");
  });

  // ---------- Withdraw ----------
  $("#withdrawBtn")?.addEventListener("click", async () => {
    const amount = parseFloat(prompt("Withdraw amount:"));
    if (!amount || amount <= 0) return alert("Invalid amount");
    await updateUserInvestment(amount, "withdraw");
  });

  async function updateUserInvestment(amount, type) {
    try {
      const balance = currentUser.investment?.balance || 0;
      const profit = currentUser.investment?.profit || 0;
      const interest = currentUser.investment?.interest || 0;

      let newBalance = type === "deposit" ? balance + amount : balance - amount;
      if (newBalance < 0) return alert("Insufficient funds");

      const res = await fetch(`${backendUrl}/user/${currentUser._id}/investment`, {
        method: "PUT",
        headers: authHeaders(),
        body: JSON.stringify({ balance: newBalance, profit, interest })
      });
      const data = await res.json();
      if (!data.success) return alert(data.message);

      // update local state & UI
      currentUser.investment = { balance: newBalance, profit, interest };
      showUserDashboard();
    } catch (err) { console.error(err); }
  }

  // ---------- Admin Login ----------
  $("#adminLoginSubmit")?.addEventListener("click", async () => {
    const email = $("#adminEmail").value;
    const password = $("#adminPassword").value;
    try {
      const res = await fetch(`${backendUrl}/admin-login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
      });
      const data = await res.json();
      if (!data.success) return alert(data.message);
      localStorage.setItem("jwtToken", data.token);
      closeModal("#adminLoginModal");
      showAdminDashboard();
    } catch (err) { console.error(err); }
  });

  // ---------- Admin Dashboard ----------
  async function showAdminDashboard() {
    $("#adminDashboard").classList.remove("hidden");

    // Load users
    const res = await fetch(`${backendUrl}/admin/users`, { headers: authHeaders() });
    const data = await res.json();
    if (!data.success) return alert(data.message);
    const tbody = $("#adminUsersBody");
    tbody.innerHTML = "";
    data.users.forEach(u => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${u.name}</td><td>${u.email}</td>
        <td>${fmtMoney(u.investment?.balance || 0)}</td>
        <td>${fmtMoney(u.investment?.profit || 0)}</td>
        <td>${fmtMoney(u.investment?.interest || 0)}</td>
        <td><button class="btn updateUser" data-id="${u._id}">Update</button></td>`;
      tbody.appendChild(tr);
    });

    // Bind update buttons
    $$(".updateUser").forEach(btn => btn.addEventListener("click", e => {
      const id = e.target.dataset.id;
      const user = data.users.find(u => u._id === id);
      if (!user) return;
      $("#editName").value = user.name;
      $("#editEmail").value = user.email;
      $("#editBalance").value = user.investment?.balance || 0;
      $("#editProfit").value = user.investment?.profit || 0;
      $("#editInterest").value = user.investment?.interest || 0;
      openModal("#updateUserForm");
      $("#saveUserBtn").onclick = async () => {
        try {
          const updatedRes = await fetch(`${backendUrl}/user/${id}/investment`, {
            method: "PUT",
            headers: authHeaders(),
            body: JSON.stringify({
              balance: parseFloat($("#editBalance").value),
              profit: parseFloat($("#editProfit").value),
              interest: parseFloat($("#editInterest").value)
            })
          });
          const updated = await updatedRes.json();
          if (!updated.success) return alert(updated.message);
          closeModal("#updateUserForm");
          showAdminDashboard();
        } catch (err) { console.error(err); }
      };
    }));

    // Load withdrawals
    refreshWithdrawals();
  }

  async function refreshWithdrawals() {
    const wdRes = await fetch(`${backendUrl}/admin/withdrawals`, { headers: authHeaders() });
    const wdData = await wdRes.json();
    if (!wdData.success) return alert(wdData.message);
    const tbody = $("#adminWdBody");
    tbody.innerHTML = "";
    wdData.withdrawals.forEach(wd => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${wd.user.name}</td><td>${wd.method}</td><td>${fmtMoney(wd.amount)}</td>
        <td>${wd.status}</td>
        <td>${wd.status==="Pending"? `<button class="btn btn-primary confirmWd" data-id="${wd._id}">Confirm</button>`:""}</td>`;
      tbody.appendChild(tr);
    });
    $$(".confirmWd").forEach(btn => btn.addEventListener("click", async e => {
      const id = e.target.dataset.id;
      const res = await fetch(`${backendUrl}/admin/withdrawals/${id}/confirm`, { method: "PUT", headers: authHeaders() });
      const data = await res.json();
      if (!data.success) return alert(data.message);
      refreshWithdrawals();
    }));
  }

  // ---------- Open Modals ----------
  $("#openLogin")?.addEventListener("click", () => openModal("#loginModal"));
  $("#openSignup")?.addEventListener("click", () => openModal("#signupModal"));
  $("#openAdminLogin")?.addEventListener("click", () => openModal("#adminLoginModal"));
  $$(".modal [data-close]").forEach(btn => btn.addEventListener("click", e => closeModal("#" + e.target.dataset.close)));
});
// ---------------------
// Live user data refresh
// ---------------------
let liveRefreshInterval;

async function fetchUserData() {
  try {
    const res = await fetch(`${backendUrl}/api/auth/current-user`, {
      headers: authHeaders(),
    });
    if (!res.ok) throw new Error("Failed to fetch user data");
    const data = await res.json();
    if (data.success) {
      const user = data.user;
      $("#statBalance").textContent = `$${user.investment.balance.toFixed(2)}`;
      $("#statProfit").textContent = `$${user.investment.profit.toFixed(2)}`;
      $("#statInterest").textContent = `$${user.investment.interest.toFixed(2)}`;
      $("#welcomeUser").textContent = `Welcome, ${user.name}`;
    }
  } catch (err) {
    console.error("Error fetching user data:", err);
  }
}

// Start auto-refresh every 10 seconds
function startLiveRefresh() {
  if (liveRefreshInterval) clearInterval(liveRefreshInterval);
  liveRefreshInterval = setInterval(fetchUserData, 10000); // 10 seconds
}

// Stop auto-refresh when user logs out
function stopLiveRefresh() {
  if (liveRefreshInterval) clearInterval(liveRefreshInterval);
}

// ---------------------
// Integrate with login flow
// ---------------------
async function handleUserLogin(token) {
  localStorage.setItem("jwtToken", token);
  $("#loginModal").classList.add("hidden");
  $("#dashboardSection").classList.remove("hidden");
  await fetchUserData();   // load initial data
  startLiveRefresh();      // start live updates
}

// ---------------------
// Stop refresh on logout
// ---------------------
$("#logoutTop").addEventListener("click", () => {
  localStorage.removeItem("jwtToken");
  $("#dashboardSection").classList.add("hidden");
  stopLiveRefresh();
});

</script>
</body>
</html>