<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Login - TradexInvest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
body {
  font-family: Arial;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  background-color: rgba(0, 0, 255, 0.479);
}
.login-box {
  padding:20px;
  border:1px solid #ccc;
  border-radius:8px;
  width:300px;
  background: #fff;
}
input { width:100%; padding:8px; margin:5px 0; }
button { width:100%; padding:8px; margin-top:10px; cursor:pointer; }
.popup {
  display:none;
  position:fixed;
  top:50%; left:50%;
  transform:translate(-50%, -50%);
  background:#fff;
  border:1px solid #ccc;
  padding:20px;
  z-index:1000;
  width:300px;
  border-radius:8px;
}
.popup h3 { margin-top:0; }
  </style>
</head>
<body>
<h2>WELCOME TO TradeXInvest</h2>

<div class="login-box">
  <h2>Login</h2>
  <form id="loginForm" onsubmit="return false;">
    <input type="email" id="email" name="email" placeholder="Email" required>
    <input type="password" id="password" name="password" placeholder="Password" required>
    <button id="loginBtn">Login</button>
  </form>
</div>

<div id="termsPopup" class="popup">
  <h3>Terms & Conditions</h3>
  <p>Welcome to TradexInvest. By using our services, you agree to the following terms:</p>
    
  <h3>1. Security Features</h3>
  <ul>
    <li><strong>Two-Factor Authentication (2FA):</strong> Recommended for account security.</li>
    <li><strong>Cold Storage:</strong> Majority of assets are stored offline.</li>
    <li><strong>Encryption:</strong> Sensitive data encrypted in transit and at rest.</li>
  </ul>

  <h3>2. Fee Structure</h3>
  <ul>
    <li>Deposit Fee: <strong>0%</strong></li>
    <li>Withdrawal Fee: <strong>1.5%</strong></li>
    <li>Trading Fee: <strong>0.25%</strong></li>
  </ul>

  <h3>3. Risk Disclosure</h3>
  <p>Investing in digital assets involves high risk, including the potential loss of your entire investment. Past performance is not indicative of future results.</p>

  <h3>4. User Agreement</h3>
  <p>By continuing, you acknowledge you have read, understood, and agree to these Terms & Conditions and our Privacy Policy.</p>

  <p>Please accept our terms to continue.</p>
  <button id="acceptTermsBtn">Accept</button>
</div>

<div id="twoFAPopup" class="popup">
  <h3>2FA Verification</h3>
  <input type="text" id="twoFAInput" placeholder="Enter 2FA code">
  <button id="verify2FABtn">Verify</button>
  <button id="resend2FABtn">Resend Code</button>
  <p id="countdown"></p>
</div>

<script>
const backendUrl = "https://tradexinvestments.onrender.com"; 

// Handle login button
document.getElementById("loginBtn").addEventListener("click", () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  if (!email || !password) {
    alert("Please enter email and password");
    return;
  }
  loginUser(email, password);
});

// Login function
async function loginUser(email, password) {
  try {
    const res = await fetch(`${backendUrl}/api/auth/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.msg || "Login failed");

    localStorage.setItem("currentUser", JSON.stringify(data));
    showTermsPopup();
  } catch (err) {
    alert(err.message);
  }
}

// Terms & Conditions popup
function showTermsPopup() {
  const termsPopup = document.getElementById("termsPopup");
  termsPopup.style.display = "block";

  document.getElementById("acceptTermsBtn").onclick = () => {
    localStorage.setItem("termsAccepted", "true");
    termsPopup.style.display = "none";
    show2FAPopup();
  };
}

// 2FA popup
let countdownTimer;
function show2FAPopup() {
  const popup = document.getElementById("twoFAPopup");
  popup.style.display = "block";
  startCountdown();

  document.getElementById("verify2FABtn").onclick = async () => {
    const code = document.getElementById("twoFAInput").value;
    const user = JSON.parse(localStorage.getItem("currentUser"));
    try {
      const res = await fetch(`${backendUrl}/api/auth/verify-2fa`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: user.email, code })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.msg);

      localStorage.setItem("twoFAVerified", "true");
      localStorage.setItem("jwtToken", data.token);
      popup.style.display = "none";
      clearInterval(countdownTimer);

      if (user.email.toLowerCase() === "youngnazzy13@gmail.com") {
        window.location.href = "admin.html";
      } else {
        window.location.href = "index.html";
      }
    } catch (err) {
      alert(err.message);
    }
  };

  document.getElementById("resend2FABtn").onclick = async () => {
    const user = JSON.parse(localStorage.getItem("currentUser"));
    try {
      const res = await fetch(`${backendUrl}/api/auth/resend-2fa`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: user.email })
      });
      const data = await res.json();
      alert(data.msg);
      startCountdown();
    } catch (err) {
      alert(err.message);
    }
  };
}

// Countdown timer
function startCountdown(duration = 300) {
  clearInterval(countdownTimer);
  const countdownEl = document.getElementById("countdown");
  let timeLeft = duration;

  countdownEl.textContent = `Code expires in: ${formatTime(timeLeft)}`;
  countdownTimer = setInterval(() => {
    timeLeft--;
    countdownEl.textContent = `Code expires in: ${formatTime(timeLeft)}`;
    if (timeLeft <= 0) {
      clearInterval(countdownTimer);
      countdownEl.textContent = "Code expired. Please resend.";
    }
  }, 1000);
}

function formatTime(seconds) {
  const min = Math.floor(seconds / 60);
  const sec = seconds % 60;
  return `${min}:${sec < 10 ? "0" + sec : sec}`;
}

// Show dashboard
function showUserDashboard(user) {
  document.getElementById("loginForm")?.remove();
  document.getElementById("twoFAPopup")?.remove();
  document.getElementById("termsPopup")?.remove();

  const dashboard = document.getElementById("dashboard") || document.createElement("div");
  dashboard.id = "dashboard";
  dashboard.innerHTML = `
    <h2>Welcome, ${user.name}</h2>
    ${user.photo ? `<img src="${backendUrl}${user.photo}" alt="Profile" width="100">` : ""}
    <p>Email: ${user.email}</p>
    <button id="logoutBtn">Logout</button>
  `;
  document.body.appendChild(dashboard);

  document.getElementById("logoutBtn").onclick = () => {
    localStorage.clear();
    window.location.reload();
  };
}

// On page load, show dashboard if already logged in
document.addEventListener("DOMContentLoaded", () => {
  const user = JSON.parse(localStorage.getItem("currentUser"));
  const twoFAVerified = localStorage.getItem("twoFAVerified");
  if (user && twoFAVerified === "true" && window.location.pathname.endsWith("index.html")) {
    showUserDashboard(user);
  }
});
</script>
</body>
</html>
